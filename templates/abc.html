import React, { useEffect, useRef, useState } from "react";
// PowerBI-Frontend.jsx
// Single-file React component for embedding Power BI reports + lightweight dashboard UI
// Tailwind CSS utility classes assumed available in the host app
// Install dependencies:
//   npm install powerbi-client
// Add a server route that returns { embedUrl, accessToken, reportId } from your backend

import * as powerbi from "powerbi-client";

export default function PowerBIFrontend() {
  const embedRef = useRef(null);
  const [reports, setReports] = useState([]); // available reports / metadata from backend
  const [activeReport, setActiveReport] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [thumbnails, setThumbnails] = useState([]); // screenshots or thumbnails

  // Fetch available reports metadata from your API
  useEffect(() => {
    async function loadReports() {
      try {
        setLoading(true);
        const res = await fetch("/api/powerbi/reports"); // implement on server
        if (!res.ok) throw new Error("Failed to load reports");
        const data = await res.json();
        // expected shape: [{ reportId, name, embedUrl, datasetName, thumbnailUrl }, ...]
        setReports(data);
        if (data.length) setActiveReport(data[0]);
      } catch (err) {
        setError(err.message);
      } finally {
        setLoading(false);
      }
    }
    loadReports();
  }, []);

  // Embed or re-embed when activeReport changes
  useEffect(() => {
    if (!activeReport) return;

    let pbix = null;
    async function embed() {
      try {
        setLoading(true);
        // Request embed token / details from backend for this report
        // backend should use Power BI REST to create an embed token for the report
        const tokenRes = await fetch(`/api/powerbi/embed-token?reportId=${activeReport.reportId}`);
        if (!tokenRes.ok) throw new Error("Failed to get embed token");
        const tokenBody = await tokenRes.json();
        // tokenBody expected: { embedUrl, accessToken, reportId }

        const embedConfig = {
          type: "report",
          id: tokenBody.reportId,
          embedUrl: tokenBody.embedUrl || activeReport.embedUrl,
          accessToken: tokenBody.accessToken,
          tokenType: powerbi.models.TokenType.Embed,
          settings: {
            panes: {
              filters: { visible: true },
              pageNavigation: { visible: true }
            },
            navContentPaneEnabled: true
          }
        };

        // cleanup previous embed if present
        const powerbiService = new powerbi.Service(powerbi.factories.hpmFactory, powerbi.factories.wpmpFactory, powerbi.factories.routerFactory);
        powerbiService.reset(embedRef.current);

        pbix = powerbiService.embed(embedRef.current, embedConfig);

        // optional: attach event handlers
        pbix.on("loaded", () => console.log("Power BI report loaded"));
        pbix.on("error", (e) => console.error(e));
      } catch (err) {
        setError(err.message);
      } finally {
        setLoading(false);
      }
    }

    embed();

    return () => {
      try {
        const powerbiService = new powerbi.Service(powerbi.factories.hpmFactory, powerbi.factories.wpmpFactory, powerbi.factories.routerFactory);
        powerbiService.reset(embedRef.current);
      } catch (e) {
        // ignore on unmount
      }
    };
  }, [activeReport]);

  // Simple handler to switch reports
  const handleSelectReport = (r) => {
    setActiveReport(r);
  };

  // Example local screenshot uploader (stores thumbnails array locally) - optional
  const handleAddThumbnail = (e) => {
    const files = Array.from(e.target.files || []);
    const newThumbs = files.map((f) => ({ name: f.name, url: URL.createObjectURL(f) }));
    setThumbnails((s) => [...newThumbs, ...s]);
  };

  return (
    <div className="min-h-screen bg-gradient-to-b from-slate-900 to-slate-800 text-white p-6">
      <header className="max-w-7xl mx-auto mb-6">
        <div className="flex items-center justify-between">
          <h1 className="text-2xl font-extrabold">Power BI Embedding — Dashboard</h1>
          <div className="text-sm text-slate-300">Connected to Power BI service</div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto grid grid-cols-12 gap-6">
        {/* Sidebar */}
        <aside className="col-span-3 bg-slate-800/60 rounded-2xl p-4 shadow-lg">
          <div className="mb-4">
            <h2 className="text-lg font-semibold">Reports</h2>
            {loading && <div className="text-sm text-slate-400">Loading...</div>}
            {error && <div className="text-sm text-red-400">{error}</div>}
          </div>

          <nav className="space-y-2">
            {reports.length === 0 && !loading ? (
              <div className="text-sm text-slate-400">No reports found. Configure /api/powerbi/reports on backend.</div>
            ) : (
              reports.map((r) => (
                <button
                  key={r.reportId}
                  onClick={() => handleSelectReport(r)}
                  className={`w-full text-left p-2 rounded-lg hover:bg-slate-700/60 transition ${activeReport && activeReport.reportId === r.reportId ? "bg-slate-700/60 border border-slate-600" : ""}`}>
                  <div className="flex items-center justify-between">
                    <div>
                      <div className="font-medium">{r.name}</div>
                      <div className="text-xs text-slate-400">{r.datasetName || "Dataset"}</div>
                    </div>
                    <div className="text-xs text-slate-400">{r.lastRefreshed ? new Date(r.lastRefreshed).toLocaleString() : "—"}</div>
                  </div>
                </button>
              ))
            )}
          </nav>

          <div className="mt-6">
            <h3 className="text-sm font-semibold mb-2">Screenshots / Thumbnails</h3>
            <input type="file" accept="image/*" onChange={handleAddThumbnail} />
            <div className="mt-2 grid grid-cols-2 gap-2">
              {thumbnails.map((t, i) => (
                <div key={i} className="rounded overflow-hidden border border-slate-700 p-1">
                  <img src={t.url} alt={t.name} className="w-full h-20 object-cover" />
                  <div className="text-xs text-slate-300 truncate mt-1">{t.name}</div>
                </div>
              ))}
            </div>
          </div>

          <div className="mt-6 text-xs text-slate-400">
            <div>Tips:</div>
            <ul className="list-disc ml-4">
              <li>Serve embed token from a secure backend endpoint.</li>
              <li>Limit access by user / role on server side.</li>
            </ul>
          </div>
        </aside>

        {/* Main embed area */}
        <section className="col-span-9 bg-slate-800/40 rounded-2xl p-4 shadow-inner min-h-[60vh]">
          <div className="flex items-center justify-between mb-3">
            <div>
              <h2 className="text-lg font-semibold">{activeReport ? activeReport.name : "Select a report"}</h2>
              <div className="text-sm text-slate-400">{activeReport ? activeReport.datasetName : "No report selected"}</div>
            </div>

            <div className="flex items-center gap-3">
              <button
                onClick={() => {
                  // example: refresh embed token + re-embed
                  if (activeReport) setActiveReport({ ...activeReport });
                }}
                className="px-3 py-1 rounded-lg bg-slate-700/60 text-sm">
                Refresh
              </button>
              <a
                href={activeReport?.embedUrl || "#"}
                target="_blank"
                rel="noreferrer"
                className="text-sm underline text-slate-300">
                Open raw
              </a>
            </div>
          </div>

          <div className="w-full h-[65vh] rounded-lg overflow-hidden border border-slate-700 bg-black">
            {/* Embedding target */}
            <div ref={embedRef} className="w-full h-full" />
          </div>

          <div className="mt-4 text-xs text-slate-400 italic">Use the "/api/powerbi/embed-token?reportId=..." endpoint to fetch short-lived embed tokens from your server.</div>
        </section>
      </main>
    </div>
  );
}
